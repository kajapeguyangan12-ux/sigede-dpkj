rules_version = '2';

// Firebase Storage Security Rules for DPKJ Application
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.role == 'admin';
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to validate image file types
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Helper function to validate document file types
    function isDocument() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.*') ||
             request.resource.contentType.matches('text/.*');
    }
    
    // Helper function to validate file size (max 10MB)
    function isValidSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // ============================================
    // PUBLIC CONTENT (Readable by everyone)
    // ============================================
    
    // E-News folder - public read, admin write
    match /e-news/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // Pengumuman folder - public read, authenticated write
    match /pengumuman/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated();
      allow create: if isAuthenticated() && isImage() && isValidSize();
    }
    
    // Pengaturan folder - for system settings
    match /pengaturan/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // Ucapan Selamat Datang
    match /ucapan-selamat-datang.jpg {
      allow read: if true;
      allow write, delete: if isAdmin();
    }
    
    // Foto Kepala Desa
    match /kepala-desa.jpg {
      allow read: if true;
      allow write, delete: if isAdmin();
    }
    
    // Slideshow images - public read, admin write
    match /slideshow/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // Popup iklan images - public read, admin write
    match /popup/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // Profil Desa images - public read, admin write
    match /profil-desa/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // Wisata Budaya images - public read, authenticated write
    match /wisata-budaya/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated();
      allow create: if isAuthenticated() && isImage() && isValidSize();
    }
    
    // Wisata Budaya with nested structure
    match /wisata-budaya/{wisataId}/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated();
      allow create: if isAuthenticated() && isImage() && isValidSize();
    }
    
    // ============================================
    // E-UMKM (E-Commerce)
    // ============================================
    
    // E-UMKM product images - public read, owner/admin write
    match /e-umkm/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated();
      allow create: if isAuthenticated() && isImage() && isValidSize();
    }
    
    // E-UMKM products with nested structure (userId/productId)
    match /e-umkm/{userId}/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && 
                     (request.auth.uid == userId || isAdmin()) && 
                     isImage() && isValidSize();
    }
    
    // Produk UMKM dengan struktur nested
    match /produk-umkm/{umkmId}/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated();
      allow create: if isAuthenticated() && isImage() && isValidSize();
    }
    
    // ============================================
    // LAYANAN PUBLIK (Public Services)
    // ============================================
    
    // Layanan Publik images - public read, admin write
    match /layanan-publik/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // Layanan Publik documents/attachments - authenticated read, authenticated write
    match /layanan-publik/{serviceId}/{userId}/{filename} {
      allow read: if isAuthenticated() && 
                   (request.auth.uid == userId || isAdmin());
      allow write, delete: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && 
                     (request.auth.uid == userId || isAdmin()) && 
                     isValidSize();
    }
    
    // ============================================
    // PENGADUAN (Public Complaints)
    // ============================================
    
    // Pengaduan images - authenticated users can upload
    match /pengaduan/{userId}/{filename} {
      allow read: if isAuthenticated() && 
                   (request.auth.uid == userId || isAdmin());
      allow write, delete: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId && 
                     isImage() && isValidSize();
    }
    
    // Alternative pengaduan path
    match /pengaduan/{filename} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated();
      allow create: if isAuthenticated() && isImage() && isValidSize();
    }
    
    // ============================================
    // DATA DESA & DOCUMENTS
    // ============================================
    
    // Data Desa KK Excel files - authenticated only
    match /data-desa-kk/{filename} {
      allow read: if isAuthenticated();
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isDocument() && isValidSize();
    }
    
    // Regulasi documents - public read, admin write
    match /regulasi/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isDocument() && isValidSize();
    }
    
    // Keuangan documents - authenticated read, admin write
    match /keuangan/{filename} {
      allow read: if isAuthenticated();
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isDocument() && isValidSize();
    }
    
    // Transparansi Desa documents
    match /transparansi/{category}/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isDocument() && isValidSize();
    }
    
    // ============================================
    // USER FILES
    // ============================================
    
    // User profile pictures - public read, owner write
    match /users/{userId}/{filename} {
      allow read: if true;
      allow write, delete: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId && 
                     isImage() && isValidSize();
    }
    
    // User documents/KTP/KK
    match /users/{userId}/documents/{filename} {
      allow read: if isAuthenticated() && 
                   (request.auth.uid == userId || isAdmin());
      allow write, delete: if isAuthenticated() && 
                            (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId && 
                     isValidSize();
    }
    
    // ============================================
    // BERITA & ARTIKEL
    // ============================================
    
    // Berita/artikel images
    match /berita/{articleId}/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // ============================================
    // GALERI
    // ============================================
    
    // Galeri/gallery images
    match /galeri/{category}/{filename} {
      allow read: if true;
      allow write, delete: if isAdmin();
      allow create: if isAdmin() && isImage() && isValidSize();
    }
    
    // ============================================
    // TEMPORARY/UPLOADS
    // ============================================
    
    // Temporary uploads (24 hour expiry should be set via lifecycle)
    match /temp/{userId}/{filename} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write, delete: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId && 
                     isValidSize();
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    
    // Deny all other paths by default for security
    // Remove or comment this in development if needed
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
